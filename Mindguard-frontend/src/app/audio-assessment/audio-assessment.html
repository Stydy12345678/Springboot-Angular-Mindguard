<div class="assessment-container">
  <h2>Audio Assessment</h2>

  <div *ngFor="let q of questions" class="question-card">
    <p class="question-text">
      {{ q.questionText }}
      <span class="status-icon"
            [ngClass]="{
              'submitted': isSubmitted(q.id),
              'not-submitted': !isSubmitted(q.id),
              'pulse': isPulsing(q.id)
            }"
            [attr.data-tooltip]="isSubmitted(q.id) ? 'Submitted âœ…' : 'Not Submitted âŒ'">
        <span *ngIf="isSubmitted(q.id)" class="checkmark">âœ”</span>
      </span>
    </p>

    <!-- Controls for users only -->
    <div *ngIf="role.toLowerCase() === 'user'" class="recording-controls">
      <button class="btn start-btn"
              [class.recording]="isRecording[q.id]"
              [disabled]="isRecording[q.id]"
              (click)="startRecording(q.id)">
        ğŸ™ Start Recording
      </button>

      <button class="btn stop-btn"
              [disabled]="!isRecording[q.id]"
              (click)="stopRecording(q.id)">
        â¹ Stop
      </button>

      <button class="btn submit-btn"
              [disabled]="!audioBlob[q.id]"
              (click)="submitRecording(q.id)">
        ğŸ“¤ Submit Answer
      </button>

      <!-- Preview recorded audio -->
      <div *ngIf="audioURL[q.id]" class="preview-audio">
        <p>Preview:</p>
        <audio [src]="audioURL[q.id]" controls></audio>
      </div>

      <!-- Show detected mood -->
      <div *ngIf="detectedMood[q.id]" class="mood-display">
        <strong>Detected Mood:</strong> {{ detectedMood[q.id] }}
      </div>
    </div>

    <!-- Message for Admin/Parent -->
    <p *ngIf="role.toLowerCase() !== 'user'" class="restricted-msg">
      Only users can record and submit answers.
    </p>
  </div>

  <hr>

  <h3>All Submitted Answers</h3>
  <div class="answers-container">
    <table class="answers-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Question ID</th>
          <th>Mood</th>
          <th>Audio</th>
          <th>Submitted At</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of answers" [ngClass]="{'current-user': a.username === username}">
          <td>{{ a.username }}</td>
          <td>{{ a.questionId }}</td>
          <td>{{ a.mood || 'â€”' }}</td>
          <td>
            <audio *ngIf="a.filePath" [src]="'http://localhost:8080/' + a.filePath" controls></audio>
          </td>
          <td>{{ a.submittedAt | date:'short' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
